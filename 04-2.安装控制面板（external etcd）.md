[TOC]

## 安装etcd集群

## 安装第一个master节点

1. `kubeadm-config` 文件配置
```

```
+ 10.152.86.143 为haproxy安装机器ip

2.  `kubeadm init`
```
mkdir -p $HOME/.kube
sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown $(id -u):$(id -g) $HOME/.kube/config
```

3. 验证
```
kubectl get pods -A
```

## 安装calico
```
# 参考文档 https://docs.projectcalico.org/v3.8/getting-started/kubernetes/
wget https://docs.projectcalico.org/v3.8/manifests/calico.yaml

# calico对应CALICO_IPV4POOL_CIDR参数需要修改为`kubeadm-config.yaml`文件的`networking.podSubnet`参数
sed -i "s#192\.168\.0\.0/16#172\.30\.0\.0/16#" calico.yaml
kubectl apply -f calico.yaml
```

## 加入master节点
```

```
+ token: 默认有效时间为24h
  * 查看token列表: `kubeadm token list`
  * 重新创建token: `kubeadm token create`
  * 生成永久有效token: `kubeadm token create --ttl 0`
+ discovery-token-ca-cert-hash: 
  `openssl x509 -pubkey -in /etc/kubernetes/pki/ca.crt | openssl rsa -pubin -outform der 2>/dev/null | openssl dgst -sha256 -hex | sed 's/^.* //'`
+ certificate-key: 
  `kubeadm init phase upload-certs --upload-certs`
